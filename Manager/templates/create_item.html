{% extends 'base.html' %}
{% load static %}

{% block title %}Add New Item{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        min-height: 100vh;
        background-color: #f8f9fa;
        padding: 2rem 1rem;
    }

    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .form-section {
        flex: 1;
        padding: 2rem;
        min-width: 400px;
    }

    .preview-section {
        flex: 1;
        padding: 2rem;
        background-color: #f8f9fa;
        border-left: 1px solid #e9ecef;
        min-width: 400px;
    }

    .form-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
        font-size: 0.95rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        background-color: white;
    }

    .form-input:focus {
        outline: none;
        border-color: #ec5228;
        box-shadow: 0 0 0 3px rgba(236, 82, 40, 0.1);
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        border: 2px solid #e5e7eb;
        padding: 0.75rem;
        border-radius: 8px;
        min-height: 50px;
        align-items: center;
        background-color: white;
        transition: border-color 0.2s;
    }

    .tags-container:focus-within {
        border-color: #ec5228;
        box-shadow: 0 0 0 3px rgba(236, 82, 40, 0.1);
    }

    .tag {
        display: inline-flex;
        align-items: center;
        background-color: #ec5228;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        margin: 2px;
        font-weight: 500;
    }

    .tag-remove {
        margin-left: 8px;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.8);
        font-weight: bold;
        font-size: 1.1rem;
        transition: color 0.2s;
    }

    .tag-remove:hover {
        color: white;
    }

    .tag-input {
        border: none;
        outline: none;
        flex-grow: 1;
        min-width: 120px;
        padding: 6px;
        font-size: 1rem;
    }

    .add-tag-button {
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: background-color 0.2s;
    }

    .add-tag-button:hover {
        background-color: #059669;
    }

    .submit-button {
        width: 100%;
        background-color: #ec5228;
        color: white;
        border: none;
        padding: 0.875rem 1.5rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        margin-top: 1rem;
    }

    .submit-button:hover {
        background-color: #d44721;
        transform: translateY(-1px);
    }

    .submit-button:active {
        transform: translateY(0);
    }

    .preview-container {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background-color: white;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-placeholder {
        color: #6b7280;
        font-size: 1.1rem;
    }

    .preview-image {
        max-width: 100%;
        max-height: 350px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .error-message {
        background-color: #fee2e2;
        color: #dc2626;
        padding: 0.75rem;
        border-radius: 8px;
        margin-top: 1rem;
        border-left: 4px solid #dc2626;
    }

    #tags {
        display: none;
    }

    @media (max-width: 1024px) {
        .form-container {
            flex-direction: column;
            margin: 1rem;
        }

        .form-section,
        .preview-section {
            min-width: unset;
            padding: 1.5rem;
        }

        .preview-section {
            border-left: none;
            border-top: 1px solid #e9ecef;
        }
    }

    @media (max-width: 640px) {
        .main-container {
            padding: 1rem 0.5rem;
        }

        .form-section,
        .preview-section {
            padding: 1rem;
        }

        .form-title {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="form-container flex">
        <div class="form-section">
            <form method="POST" enctype="multipart/form-data" action="">
                {% csrf_token %}
                <h1 class="form-title">Add New Item</h1>

                <div class="form-group">
                    <label for="name" class="form-label">Item Name:</label>
                    <input type="text" name="name" id="name" required class="form-input" />
                </div>

                <div class="form-group">
                    <label for="price" class="form-label">Price:</label>
                    <input type="number" name="price" id="price" step="0.01" required class="form-input" />
                </div>

                <div class="form-group">
                    <label for="quantity" class="form-label">Quantity:</label>
                    <input type="number" name="quantity" id="quantity" required class="form-input" />
                </div>

                <div class="form-group">
                    <label for="category" class="form-label">Category:</label>
                    <input type="text" name="category" id="category" class="form-input" />
                </div>

                <div class="form-group">
                    <label for="itemtype" class="form-label">Item Type:</label>
                    <input type="text" name="itemtype" id="itemtype" class="form-input" />
                </div>

                <div class="form-group">
                    <label for="images" class="form-label">Images:</label>
                    <input type="file" name="images" id="images" accept="image/*" class="form-input" />
                </div>

                <div class="form-group">
                    <label for="availablity" class="form-label">Availability:</label>
                    <select name="availablity" id="availablity" class="form-input">
                        <option value="True">Available</option>
                        <option value="False">Unavailable</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tags" class="form-label">Tags:</label>
                    <div class="tags-container" id="tags-container">
                        <input type="text" class="tag-input" id="tag-input" placeholder="Add a tag and press Enter" />
                        <button type="button" class="add-tag-button" id="add-tag-button">Add</button>
                    </div>
                    <select name="tags" id="tags" multiple>
                    </select>
                </div>

                <button type="submit" class="submit-button">Add Item</button>
            </form>

            {% if error %}
            <div class="error-message">{{ error }}</div>
            {% endif %}
        </div>

        <div class="preview-section">
            <div class="preview-container" id="images-preview">
                <div class="preview-placeholder" id="preview-placeholder">
                    <p>ðŸ“· Select an image to see preview here</p>
                </div>
                <div class="preview-grid" id="preview-grid"></div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    const tagsContainer = document.getElementById('tags-container');
    const tagInput = document.getElementById('tag-input');
    const addTagButton = document.getElementById('add-tag-button');
    const tagsSelect = document.getElementById('tags');
    const imagesInput = document.getElementById('images');
    const previewGrid = document.getElementById('preview-grid');
    const previewPlaceholder = document.getElementById('preview-placeholder');

    let selectedFile = null;

    // Function to add a tag to the container and select element
    function addTag(tagText) {
        if (tagText.trim() === '') return;

        // Prevent duplicate tags (case-insensitive)
        const existingTags = Array.from(tagsSelect.options).map(opt => opt.value.toLowerCase());
        if (existingTags.includes(tagText.toLowerCase())) return;

        // Create tag element
        const tagElement = document.createElement('span');
        tagElement.className = 'tag';
        tagElement.innerHTML = `${tagText}<span class="tag-remove" data-tag="${tagText}">Ã—</span>`;
        tagsContainer.insertBefore(tagElement, tagInput);

        // Add to hidden select for form submission
        const option = document.createElement('option');
        option.value = tagText;
        option.selected = true;
        tagsSelect.appendChild(option);

        // Clear input
        tagInput.value = '';
    }

    // Function to remove a tag
    function removeTag(tagText) {
        const tagElements = tagsContainer.querySelectorAll('.tag');
        tagElements.forEach(element => {
            if (element.querySelector('.tag-remove').dataset.tag === tagText) {
                element.remove();
            }
        });
        const options = tagsSelect.querySelectorAll('option');
        options.forEach(option => {
            if (option.value === tagText) {
                option.remove();
            }
        });
    }

    // Function to remove image
    function removeImage() {
        selectedFile = null;
        imagesInput.value = '';
        displayPreviews();
    }

    // Function to display image previews
    function displayPreviews() {
        previewGrid.innerHTML = '';

        if (!selectedFile) {
            previewPlaceholder.style.display = 'block';
            return;
        }

        previewPlaceholder.style.display = 'none';

        const reader = new FileReader();
        reader.onload = function (e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Preview" class="preview-image">
            `;
            previewGrid.appendChild(previewItem);
        };
        reader.readAsDataURL(selectedFile);
    }

    // Handle image selection
    imagesInput.addEventListener('change', function (e) {
        if (e.target.files.length > 0) {
            selectedFile = e.target.files[0];
            displayPreviews();
        }
    });

    // Make removeImage function global
    window.removeImage = removeImage;

    // Handle tag addition on button click
    addTagButton.addEventListener('click', () => {
        addTag(tagInput.value.trim());
    });

    // Handle tag removal
    tagsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('tag-remove')) {
            const tagText = e.target.dataset.tag;
            removeTag(tagText);
        }
    });

    // Handle Enter key for adding tags
    tagInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag(tagInput.value.trim());
        }
    });
</script>
{% endblock %}

{% endblock %}